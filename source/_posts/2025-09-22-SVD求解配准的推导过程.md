---
title: SVD求解配准的推导过程
date: 2025-09-22 21:31:31
mathjax: true
toc:
  number: false
categories:
- Reading Notes
- geometry
tags: 
- Reading Notes
- geometry
---

 **配准误差函数 \$E(R,t)\$ 与 SVD + IQR 的完整推导**

下面整理配准中计算推导过程，包含：平移 \$t\$ 的消去（逐项展开并对 \$t\$ 求导的详细步骤）、矩阵/范数形式的推导、SVD（Kabsch）求解旋转 \$R\$ 的严格证明，以及 IQR 筛除离群点的直观解释与算法流程。

---

# 问题设定

给定两组对应点

* 源点 $P={p_i}_{i=1}^n\subset\mathbb{R}^d$，
* 目标点 $Q={q_i}_{i=1}^n\subset\mathbb{R}^d$，

希望求刚体变换（旋转 $R$ 与平移 $t$）：

$$
q_i \approx R p_i + t,
$$

使平方误差

$$
E(R,t)=\sum_{i=1}^n \|q_i - (R p_i + t)\|^2
$$

最小。

> 在下文中，$R$ 通常取为正交矩阵（理想为 $R\in\mathrm{SO}(d)$，即 $R^T R=I$ 且 $\det R=+1$。\
> $SO(d)$ 特殊正交群 (Special Orthogonal Group) $$SO(d) = \{\, R \in \mathbb{R}^{d \times d} \;\mid\; R^T R = I,\; \det(R) = 1 \,\}$$


---

# 1. 消去平移 $t$（逐项展开并对 $t$ 求导）

这是把问题从同时求 $R,t$ 化为先固定 $R$ 求 $t$，再代回仅关于 $R$ 的问题的标准做法。

## 1.1 逐项展开

对第 $i$ 项展开：

$$
\|q_i - (R p_i + t)\|^2 = (q_i - R p_i - t)^T (q_i - R p_i - t).
$$

把它展开为三项：

$$
(q_i - R p_i)^T(q_i - R p_i) - 2 (q_i - R p_i)^T t + t^T t.
$$

## 1.2 对所有点求和

$$
\begin{aligned}
E(R,t) &= \sum_{i=1}^n \Big[(q_i - R p_i)^T(q_i - R p_i) - 2 (q_i - R p_i)^T t + t^T t\Big] \\
&= \underbrace{\sum_{i=1}^n (q_i - R p_i)^T(q_i - R p_i)}_{C\text{（与 }t\text{ 无关）}} - 2 t^T \sum_{i=1}^n (q_i - R p_i) + n\, t^T t.
\end{aligned}
$$

注意最后一项合并为 $n,t^T t$，因为 $t$ 对每一项相同。

## 1.3 对 $t$ 求导并令导数为零

使用向量求导规则：

* $\dfrac{\partial}{\partial t}(t^T a) = a$,
* $\dfrac{\partial}{\partial t}(t^T t) = 2t$.

因此：

$$
\frac{\partial E}{\partial t} = -2 \sum_{i=1}^n (q_i - R p_i) + 2 n t.
$$

令导数为零得到最优 $t$：

$$
-2 \sum_{i=1}^n (q_i - R p_i) + 2 n t = 0 \quad\Rightarrow\quad t^\star = \frac{1}{n} \sum_{i=1}^n (q_i - R p_i).
$$

将上式分离为质心形式：记

$$
\bar p = \frac{1}{n}\sum_{i=1}^n p_i,\qquad \bar q = \frac{1}{n}\sum_{i=1}^n q_i,
$$

得到

$$
\boxed{\quad t^\star = \bar q - R \bar p \quad}
$$

这就是“消去平移”的结果：最优的平移等于把源点质心经 \$R\$ 旋转后移到目标点质心。

## 1.4 代回得到中心化问题

用

$\tilde p_i := p_i - \bar p, \qquad \tilde q_i := q_i - \bar q,$

将$t^\star$带入到$E(R,t)$可得

$$
E(R,t^\star) = \sum_{i=1}^n \|\tilde q_i - R \tilde p_i\|^2.
$$

因此剩下的任务变为在去掉质心后的两组点上仅求旋转 \$R\$ 以最小化上式。

---

# 2. 矩阵 / Frobenius 范数形式的推导

把点堆成矩阵（列为点）更紧凑：

* 设 $P=[p_1; p_2;\cdots; p_n]\in\mathbb{R}^{d\times n}$,
* $Q=[q_1; q_2;\cdots; q_n]\in\mathbb{R}^{d\times n}$,
* $\mathbf{1}\in\mathbb{R}^n$ 为全 1 向量。

则总体误差写作 Frobenius 范数：

$$
E(R,t) = \|Q - R P - t\,\mathbf{1}^T\|_F^2.
$$

展开（使用 $|A|_F^2 = \mathrm{trace}(A^T A)$）：

$$
E(R,t) = \mathrm{trace}\big[(Q - R P - t\mathbf{1}^T)^T(Q - R P - t\mathbf{1}^T)\big].
$$

对 $t$ 求导的快速方式：把 $E$ 看作关于 $t$ 的二次型，使用矩阵微分规则可得

$$
\frac{\partial E}{\partial t} = -2 (Q - R P) \mathbf{1} + 2 n t.
$$

注意 $(Q-RP)\mathbf{1} = \sum\_{i=1}^n (q\_i - R p\_i)$，因此上式与逐项展开的结果一致，进而得到

$$
t^\star = \frac{1}{n} (Q - R P) \mathbf{1} = \bar q - R \bar p.
$$

---

# 3. 求解旋转 $R$：SVD（Kabsch/Procrustes）证明

在确定了最优平移后，问题变为最小化

$$
E(R) := E(R,t^\star) = \sum_{i=1}^n \|\tilde q_i - R \tilde p_i\|^2.
$$

目标是找到 $R$（正交/旋转矩阵）使 $E(R)$ 最小。

## 3.1 把问题转化为最大化迹

展开平方和：

$$
\begin{aligned}
E(R) &= \sum_i \big(\|\tilde q_i\|^2 + \|\tilde p_i\|^2 - 2 \tilde q_i^T R \tilde p_i\big) \\
&= \text{const} - 2 \sum_i \tilde q_i^T R \tilde p_i.
\end{aligned}
$$

因此最小化 $E(R)$ 等价于最大化

$$
\sum_{i=1}^n \tilde q_i^T R \tilde p_i = \mathrm{trace}\Big(R \sum_{i=1}^n \tilde p_i \tilde q_i^T\Big).
$$

定义交叉协方差（或交叉矩阵）

$$
H = \sum_{i=1}^n \tilde p_i \tilde q_i^T \in \mathbb{R}^{d\times d}.
$$

## 3.2 对 $H$ 做 SVD

设

$$
H = U \Sigma V^T,
$$

其中 $U,V\in O(d)$（正交矩阵），$\Sigma=\mathrm{diag}(\sigma\_1,\ldots,\sigma\_d)$，$\sigma\_1\ge\cdots\ge\sigma\_d\ge0$。

## 3.3 用迹的不等式最大化 $\mathrm{trace}(R H)$

$$
\mathrm{trace}(R H) = \mathrm{trace}(R U \Sigma V^T) = \mathrm{trace}(V^T R U \Sigma).
$$

令 $S:=V^T R U$。由于 $R,U,V$ 正交，则 $S$ 也为正交矩阵，其对角元满足 $|s\_{ii}|\le 1$。于是

$$
\mathrm{trace}(R H) = \sum_{i=1}^d s_{ii} \sigma_i \le \sum_{i=1}^d \sigma_i.
$$

上界在 $S=I$ 时取到，这对应于

$$
V^T R U = I \quad\Rightarrow\quad R = V U^T.
$$

因此取

$$
\boxed{\quad R = V U^T \quad}
$$

可以使 $\mathrm{trace}(R H)$ 达到最大，从而 $E(R)$ 达到最小。

### 3.4 反射修正（保证 $\det R = +1$）

若 $\det(V U^T) = -1$，则 $V U^T$ 包含一次反射（不是纯旋转）。为了保证 $R\in\mathrm{SO}(d)$，我们做标准修正：

$$
D = \mathrm{diag}(1,\ldots,1,\det(V U^T)),\qquad R = V D U^T.
$$

这相当于将 $\Sigma$ 的最后一个奇异值对应的符号做调整，从而避免反射并保持在旋转群内。

---

# 4. $\dfrac{\partial E}{\partial t}$ 的显式表达

总结前面单项展开得到的导数：

$$
\boxed{\quad \frac{\partial E}{\partial t} = -2 \sum_{i=1}^n (q_i - R p_i) + 2 n t \quad}
$$

最优点处令其为零，得到 $t^\star = \dfrac{1}{n} \sum_{i=1}^n (q_i - R p_i)=\bar q - R\bar p$。

---

# 5. 离群点的影响与 IQR（四分位距）筛选的作用

## 5.1 最小二乘对离群点的敏感性

最小二乘目标是平方残差和：

$$
E = \sum_{i=1}^n r_i^2,\qquad r_i := \|q_i - (R p_i + t)\|.
$$

离群点若使某些 \$r\_i\$ 非常大，则这些项按平方被放大，会主导总误差，导致最优解被少数异常值拉偏。

## 5.2 IQR 的基本思想

IQR 基于残差的分位数：计算残差集合的第一四分位数 \$Q1\$（下四分位数：数据中 25% 的值）、第三四分位数 \$Q3\$（上四分位数：数据中 75% 的值），四分位距 \$\mathrm{IQR}=Q3-Q1\$。常用的离群点阈值为

$$
[Q1 - k\cdot\mathrm{IQR},\; Q3 + k\cdot\mathrm{IQR}],
$$

通常取 $k=1.5$。超出该区间的残差被视为离群点并剔除。

## 5.3 IQR + SVD 的算法流程（常见实现）

1. **初始化匹配**：根据最近邻或特征匹配得到点对 $(p_i,q_i)$（可能包含错误匹配）。
2. **初始估计**：可用简单的初始 $R$（例如单位矩阵）或用全部点快速估计一次 $R,t$（直接 SVD）。
3. **计算残差**：$r_i = |q_i - (R p_i + t)|$。
4. **IQR 筛选**：计算 $Q1,Q3,\mathrm{IQR}$，保留满足 $Q1 - k\mathrm{IQR} \le r_i \le Q3 + k\mathrm{IQR}$ 的点（这些称为内点）。
5. **用内点重算**：对内点应用中心化 + SVD（Kabsch）得到新的 $R,t$。
6. **可选迭代**：重复步骤 3–5，直到内点集稳定或 $R,t$ 的变化小于阈值。

> 注意：IQR 筛选是一种简单且实用的预处理，它能在少数离群点存在时显著提升 SVD 解的稳健性。但它不是唯一或最优的鲁棒方法：可选替代包括 RANSAC、trimmed least squares、M-estimators（例如 Huber 损失）等。

## 5.4 简要的理论直观说明

若离群点集合 \$O\$ 中的残差下界为很大的常数 \$M\$，那么离群点对总误差的贡献至少为 \$|O|M^2\$。当该量远大于内点误差和时，最小二乘会被迫优先降低离群点误差，从而牺牲对大多数点的拟合。IQR 通过剔除这些极端残差，使得 SVD 最小化的目标更贴近对大多数点的最佳拟合，从而提高鲁棒性。

---

# 6. 扩展与补充

* **加权情形**：若每对 $(p_i,q_i)$ 有权重 $w_i$，则可用带权质心与加权协方差：
  $\bar p_w=\frac{\sum w_i p_i}{\sum w_i},\quad H=\sum w_i (p_i-\bar p_w)(q_i-\bar q_w)^T.$
  最优平移为 $t^\star=\bar q_w - R\bar p_w$，$R$ 仍可由加权 $H$ 做 SVD 得到。

* **其他鲁棒方法**：RANSAC（随机采样一致性）在存在大量错误匹配时极其有效；M-estimator 通过修改损失函数减小大残差的影响；trimmed least squares 则直接在目标中剔除一定比例的大残差项并全局优化。

---

# 结论

* 对 $E(R,t)$ 关于 $t$ 求导并设导数为零可得到明确的闭式解 $t^\star=\bar q - R \bar p$，即最优平移把源点质心的变换结果对齐到目标质心。
* 在去掉质心后，旋转 $R$ 可通过最大化 $\mathrm{trace}(R H)$ 来求解，使用 $H$ 的 SVD（Kabsch 算法）给出解析解 $R=V U^T$（必要时修正避免反射）。
* 当存在离群点时，直接最小二乘（L2）解容易被极端值主导。使用 IQR 进行残差筛除可以显著提高 SVD 求解的稳健性；更严谨或更鲁棒的替代方案有 RANSAC、M-estimators 等。

---

# 附录：常用矩阵/向量求导规则（本推导中用到）

* $\dfrac{\partial}{\partial x}(x^T a) = a$（$a$ 与 $x$ 维度一致）
* $\dfrac{\partial}{\partial x}(x^T x) = 2x$
* $\dfrac{\partial}{\partial X} \mathrm{trace}(A X) = A^T$ （矩阵导数规则，按需使用）

